"""
Explores different `tag` contents.
"""
from collections import defaultdict
from pprint import pprint
import json
import xml.etree.cElementTree as ET

from mapparser import count_tags

OSMFILE = "data/austin.osm"
TAG_KEYS = [('highway', 67137), ('name', 41954), ('tiger:county', 35058), ('tiger:cfcc', 35037), ('tiger:reviewed', 32442), ('tiger:name_base', 28536), ('tiger:tlid', 26725), ('tiger:source', 26710), ('tiger:name_type', 26254), ('tiger:separated', 24167), ('tiger:zip_left', 21001), ('tiger:zip_right', 19591), ('building', 12487), ('odbl', 10223), ('oneway', 9506), ('created_by', 8353), ('tiger:upload_uuid', 7913), ('amenity', 7006), ('service', 5894), ('ref', 3695), ('access', 3620), ('surface', 2886), ('tiger:name_direction_prefix', 2691), ('tiger:name_base_1', 2638), ('power', 2490), ('public_transport', 2444), ('landuse', 2090), ('lanes', 2044), ('addr:housenumber', 1949), ('source', 1910), ('addr:street', 1879), ('name_1', 1804), ('ele', 1736), ('leisure', 1709), ('natural', 1547), ('gnis:feature_id', 1518), ('bridge', 1475), ('maxspeed', 1380), ('layer', 1319), ('type', 1243), ('gnis:created', 1230), ('gnis:county_id', 1190), ('gnis:state_id', 1188), ('operator', 1107), ('website', 1085), ('foot', 1062), ('bicycle', 998), ('addr:postcode', 979), ('shop', 938), ('sport', 915), ('network', 902), ('tiger:name_type_1', 854), ('waterway', 819), ('old_ref', 806), ('toll', 765), ('bus', 748), ('tiger:zip_left_1', 745), ('note', 739), ('addr:city', 732), ('sidewalk', 633), ('barrier', 602), ('motor_vehicle', 579), ('cuisine', 554), ('shelter', 552), ('tiger:name_direction_suffix', 550), ('area', 507), ('covered', 502), ('addr:state', 496), ('railway', 463), ('bench', 450), ('religion', 449), ('cycleway', 438), ('golf', 422), ('horse', 417), ('source:maxspeed', 411), ('tracktype', 405), ('NHS', 405), ('old_name', 369), ('phone', 346), ('gnis:county_name', 305), ('place', 303), ('parking', 296), ('tiger:zip_right_1', 291), ('tiger:name_direction_prefix_1', 291), ('tourism', 280), ('destination', 279), ('crossing', 270), ('gnis:import_uuid', 260), ('gnis:reviewed', 259), ('gauge', 253), ('tiger:name_base_2', 245), ('denomination', 242), ('emergency', 225), ('route', 220), ('shelter_type', 217), ('alt_name', 214), ('frequency', 210), ('is_in', 210), ('construction', 208), ('voltage', 203), ('boundary', 183), ('man_made', 176), ('admin_level', 175), ('border_type', 163), ('hgv', 158), ('gnis:ST_alpha', 154), ('gnis:County', 154), ('gnis:Class', 153), ('gnis:id', 153), ('gnis:ST_num', 153), ('import_uuid', 153), ('gnis:County_num', 153), ('lit', 147), ('addr:housename', 147), ('tiger:zip_left_2', 143), ('building:levels', 142), ('aeroway', 141), ('wheelchair', 133), ('footway', 132), ('grades', 129), ('isced:level', 126), ('FIXME', 125), ('tiger:name_direction_suffix_1', 123), ('tunnel', 118), ('wikipedia', 115), ('water', 115), ('traffic_calming', 112), ('Texas_Trunk_System', 111), ('source:Texas_Trunk_System', 111), ('old_railway_operator', 111), ('historic', 110), ('name_2', 100), ('junction', 97), ('nrhp:id', 86), ('exit_to', 86), ('cables', 78), ('restriction', 78), ('traffic_signals:sound', 73), ('button_operated', 72), ('payment:bitcoin', 71), ('office', 69), ('tiger:name_type_2', 68), ('route_ref', 67), ('description', 66), ('fee', 64), ('boat', 62), ('is_in:state', 62), ('fire_hydrant:type', 61), ('tiger:PCINECTA', 60), ('tiger:CPI', 60), ('tiger:FUNCSTAT', 60), ('tiger:CLASSFP', 60), ('tiger:MTFCC', 60), ('tiger:PCICBSA', 60), ('destination:ref', 59), ('proposed', 59), ('tiger:LSAD', 59), ('tiger:PLACEFP', 59), ('tiger:NAMELSAD', 59), ('tiger:NAME', 59), ('tiger:PLCIDFP', 58), ('tiger:STATEFP', 58), ('tiger:PLACENS', 58), ('is_in:country_code', 56), ('is_in:country', 56), ('opening_hours', 56), ('is_in:state_code', 56), ('is_in:iso_3166_2', 56), ('place_name', 55), ('tiger:name_base_3', 54), ('noref', 51), ('tiger:zip_right_2', 50), ('note:odbl', 49), ('expressway', 48), ('supervised', 44), ('gnis:feature_type', 44), ('noexit', 44), ('tiger:name_direction_prefix_2', 43), ('source_ref', 43), ('tiger:zip_left_3', 43), ('park_ride', 43), ('source:name', 42), ('bicycle_parking', 38), ('design', 38), ('fixme', 37), ('contact:phone', 36), ('information', 35), ('direction', 34), ('stop', 34), ('population', 32), ('brand', 31), ('loc_name', 29), ('turn:lanes', 27), ('capacity', 25), ('atm', 25), ('smoking', 24), ('tiger:zip_left_4', 24), ('census:population', 24), ('reg_ref', 23), ('level', 23), ('designation', 22), ('segregated', 22), ('tower:type', 22), ('lake:surface_area:acres', 21), ('lake:max_depth', 21), ('lake:max_depth:feet', 21), ('lake:surface_area', 21), ('width', 21), ('ele:feet', 21), ('lake:shore_length:miles', 21), ('lake:shore_length', 21), ('official_name', 20), ('unsigned_ref', 20), ('waste', 20), ('entrance', 19), ('colour', 18), ('tiger:zip_right_3', 18), ('sloped_curb', 17), ('parking:lane:both', 17), ('symbol', 16), ('official_ref', 16), ('surveillance', 15), ('parking:condition:both', 15), ('history', 15), ('to', 14), ('have_riverbed', 14), ('capacity:disabled', 14), ('from', 14), ('gnis:fcode', 13), ('incline', 13), ('oneway:bicycle', 12), ('addr:country', 12), ('tactile_paving', 12), ('tiger:name_type_3', 12), ('public_transport:version', 12), ('internet_access', 11), ('intermittent', 11), ('tiger:zip_right_4', 11), ('destination:ref:to', 11), ('voltage-high', 11), ('bridge:name', 10), ('craft', 10), ('maxspeed:conditional', 10), ('drive_through', 10), ('school_type', 10), ('name_3', 10), ('generator:source', 9), ('height', 9), ('generator:output:electricity', 9), ('tiger:name_direction_suffix_3', 9), ('generator:method', 9), ('modifier', 9), ('tiger:name_direction_suffix_2', 8), ('sac_scale', 8), ('nist:state_fips', 8), ('nist:fips_code', 8), ('attribution', 8), ('lcn', 7), ('par', 7), ('length', 7), ('takeaway', 7), ('outdoor_seating', 7), ('lcn_ref', 7), ('addr:unit', 7), ('cash', 6), ('reference', 6), ('source:ref', 6), ('drive_thru', 6), ('source:ref:note', 6), ('wifi', 5), ('dispensing', 5), ('voltage-low', 5), ('route_master', 5), ('noturn', 5), ('basin', 5), ('name:ru', 5), ('note:lanes', 5), ('name:en', 5), ('surveillance:type', 5), ('fireplace', 5), ('local_ref', 4), ('garage', 4), ('Destination', 4), ('toll:automatic', 4), ('toilets:disposal', 4), ('key', 4), ('fuel:diesel', 4), ('embankment', 4), ('priority_road', 4), ('fax', 4), ('reg_name', 3), ('delivery', 3), ('payment:litecoin', 3), ('usage', 3), ('abandoned', 3), ('short_name', 3), ('wood', 3), ('social_facility', 3), ('url', 3), ('addr:full', 3), ('name:zh', 3), ('name:ar', 3), ('mtb:scale', 3), ('collection_times', 3), ('source:note', 3), ('diet:vegetarian', 3), ('name:pl', 3), ('crop', 3), ('name:uk', 3), ('name:nv', 2), ('addr:county', 2), ('parking:lane:right', 2), ('self_service', 2), ('name:qu', 2), ('odbl:note', 2), ('contact:website', 2), ('cartype', 2), ('cycleway:left', 2), ('name:de', 2), ('gnis:freature_id', 2), ('isced', 2), ('name:cu', 2), ('fence_type', 2), ('payment:notes', 2), ('name:yi', 2), ('name:oc', 2), ('color', 2), ('maxspeed:backward', 2), ('comment', 2), ('contact:email', 2), ('name:ta', 2), ('lamp_type', 2), ('email', 2), ('name:eo', 2), ('name:el', 2), ('capacity:parent', 2), ('name:kw', 2), ('name:ka', 2), ('sale', 2), ('state_capital', 2), ('disused:amenity', 2), ('name:hak', 2), ('name:haw', 2), ('wikidata', 2), ('name:hr', 2), ('name:ht', 2), ('name:hy', 2), ('name:he', 2), ('name:hi', 2), ('name:sr', 2), ('name:sl', 2), ('gnis:edited', 2), ('cutting', 2), ('name:th', 2), ('name:tr', 2), ('name:fa', 2), ('name:fi', 2), ('name:ml', 2), ('name:mr', 2), ('capacity:women', 2), ('FIXME:ref', 2), ('military', 2), ('hoops', 2), ('name:bg', 2), ('name:be', 2), ('name:bn', 2), ('name:ja', 2), ('disused', 2), ('name:ur', 2), ('automated', 2), ('name:ko', 2), ('maxspeed:forward', 1), ('name:gu', 1), ('name:gv', 1), ('name:gl', 1), ('name:gn', 1), ('name:gd', 1), ('name:ga', 1), ('name:vep', 1), ('county_fips', 1), ('name:na', 1), ('recycling:paper_packaging', 1), ('name:nn', 1), ('recycling:beverage_cartons', 1), ('nq', 1), ('name:cbk-zam', 1), ('alt_name:vi', 1), ('wetap:statusnote', 1), ('name:mwl', 1), ('name:ab', 1), ('recycling_type', 1), ('gnis_freature_id', 1), ('name:ksh', 1), ('name:stq', 1), ('fut_ref', 1), ('name:fiu-vro', 1), ('recycling:plastic', 1), ('name:am', 1), ('County', 1), ('recycling:glass_bottles', 1), ('name:ltg', 1), ('name:backward', 1), ('name:pfl', 1), ('name:pag', 1), ('name:av', 1), ('name:pam', 1), ('name:zh-classical', 1), ('ford', 1), ('name:pap', 1), ('complete', 1), ('name:csb', 1), ('name:ang', 1), ('stars', 1), ('name:mhr', 1), ('Paved', 1), ('name:zh-min-nan', 1), ('name:az', 1), ('addr:streetnumber', 1), ('propsoed', 1), ('name:ay', 1), ('name:mzn', 1), ('name:pih', 1), ('name:jbo', 1), ('nudism', 1), ('name:jv', 1), ('destination:right', 1), ('name:no', 1), ('name:nl', 1), ('name:nap', 1), ('name:nah', 1), ('recycling:cans', 1), ('vending', 1), ('Shop', 1), ('bridge_name', 1), ('Length', 1), ('name:dsb', 1), ('name:chr', 1), ('fuel:biodiesel', 1), ('government', 1), ('elevation', 1), ('name:chy', 1), ('name:dv', 1), ('location', 1), ('name:dz', 1), ('payment:vertcoin', 1), ('name:mdf', 1), ('name:da', 1), ('name:kaa', 1), ('name:simple', 1), ('name:ca', 1), ('ref:fips', 1), ('name:ce', 1), ('name:cs', 1), ('name:cv', 1), ('name:lb', 1), ('old_name:vi', 1), ('bicycle:oneway', 1), ('name:wuu', 1), ('name:udm', 1), ('name:pdc', 1), ('name:fur', 1), ('undefined', 1), ('name:be-x-old', 1), ('fuel:octane_95', 1), ('fuel:octane_91', 1), ('parts', 1), ('ISO3166-1:alpha3', 1), ('fuel:octane_98', 1), ('name:ext', 1), ('name:vo', 1), ('name:nds-nl', 1), ('name:vi', 1), ('social_facility:for', 1), ('name:koi', 1), ('note:ref', 1), ('name:yo', 1), ('twoway', 1), ('name:bar', 1), ('fuel:biogas', 1), ('name:brand', 1), ('osmarenderer', 1), ('name:new', 1), ('name:tk', 1), ('source:noname', 1), ('al', 1), ('car_wash', 1), ('name:bcl', 1), ('name:rw', 1), ('ref:right', 1), ('recycling:cartons', 1), ('name:myv', 1), ('name:or', 1), ('name:os', 1), ('name:om', 1), ('parking:lane:left', 1), ('name:sah', 1), ('name:kab', 1), ('destination:left', 1), ('name:bm', 1), ('name:hsb', 1), ('EXit_to', 1), ('name:mrj', 1), ('name:krc', 1), ('building:use', 1), ('commercial', 1), ('lanes:backward', 1), ('lanes:forward', 1), ('name:tg', 1), ('name:tn', 1), ('ISO3166-1:alpha2', 1), ('parking:condition:left', 1), ('name:co', 1), ('name:ckb', 1), ('name:eml', 1), ('name:tl', 1), ('name:ro', 1), ('name:rn', 1), ('name:rm', 1), ('name:es', 1), ('power_source', 1), ('name:eu', 1), ('name:lij', 1), ('official_name:vi', 1), ('moving boxes', 1), ('name:ee', 1), ('name:lo', 1), ('name:ln', 1), ('name:li', 1), ('roundabout', 1), ('name:la', 1), ('trail_visibility', 1), ('name:lt', 1), ('addr:suite', 1), ('name:lv', 1), ('presbyterian', 1), ('local', 1), ('name:tet', 1), ('name:ky', 1), ('name:ku', 1), ('payment:debit_cards', 1), ('name:ki', 1), ('indoor', 1), ('name:km', 1), ('text', 1), ('name:nds', 1), ('payment:coins', 1), ('name:bpy', 1), ('name:wo', 1), ('name:pcd', 1), ('ref:left', 1), ('name:wa', 1), ('name:xal', 1), ('Name', 1), ('name:roa-tara', 1), ('opening hours', 1), ('name:iu', 1), ('recycling:cardboard', 1), ('noname', 1), ('name:vls', 1), ('name:nov', 1), ('name:lmo', 1), ('name:szl', 1), ('name:cy', 1), ('name:srn', 1), ('distance', 1), ('name:hu', 1), ('name:io', 1), ('name:ha', 1), ('tiger:NameLSAD', 1), ('name:xh', 1), ('enforcement', 1), ('short_name:vi', 1), ('name:id', 1), ('name:ie', 1), ('name:diq', 1), ('recycling:glass', 1), ('name:tpi', 1), ('origin', 1), ('nhd:com_id', 1), ('nhd:reach_code', 1), ('organic', 1), ('name:sq', 1), ('name:ss', 1), ('name:su', 1), ('name:sv', 1), ('name:sw', 1), ('name:et', 1), ('name:arz', 1), ('name:arc', 1), ('name:sa', 1), ('electrified', 1), ('name:sd', 1), ('name:se', 1), ('name:sh', 1), ('name:war', 1), ('name:sk', 1), ('name:sm', 1), ('name:sn', 1), ('name:so', 1), ('name:ilo', 1), ('name:za', 1), ('diesel', 1), ('internet_access:fee', 1), ('name:zu', 1), ('ISO3166-1:numeric', 1), ('name:af', 1), ('Type', 1), ('payment:credit_cards', 1), ('name:an', 1), ('full_name', 1), ('wpt_symbol', 1), ('health_specialty:palliative_medicine', 1), ('name:as', 1), ('name:gan', 1), ('recycling:plastic_bags', 1), ('recycling:plastic_bottles', 1), ('currency:XBT', 1), ('city_served', 1), ('recycling:aluminium', 1), ('name:fy', 1), ('recycling:newspaper', 1), ('source:population', 1), ('practice', 1), ('name:pms', 1), ('fuel:gas', 1), ('cash_in', 1), ('name:te', 1), ('exit_to:right', 1), ('int_ref', 1), ('name:to', 1), ('postal_code', 1), ('payment:cash', 1), ('name:tt', 1), ('name:tw', 1), ('name:ts', 1), ('population:date', 1), ('name:ty', 1), ('name:lg', 1), ('addr:place', 1), ('wetap:status', 1), ('rental', 1), ('name:glk', 1), ('name:ceb', 1), ('trees', 1), ('name:zea', 1), ('beauty', 1), ('iata', 1), ('exit_to:left', 1), ('name:nso', 1), ('name:fr', 1), ('name:fo', 1), ('name:hif', 1), ('name:xmf', 1), ('name:ff', 1), ('source:ele', 1), ('name:mk', 1), ('name:mi', 1), ('name:mn', 1), ('name:mg', 1), ('Lit', 1), ('ISO3166-2', 1), ('name:my', 1), ('name:ms', 1), ('construciton', 1), ('name:ace', 1), ('name:min', 1), ('name:pnb', 1), ('name:bxr', 1), ('name:lad', 1), ('name:vec', 1), ('flag', 1), ('ISO3166-1', 1), ('club', 1), ('name:scn', 1), ('name:sco', 1), ('start_date', 1), ('name:rue', 1), ('name:ne', 1), ('name:cdo', 1), ('name:pa', 1), ('name:mt', 1), ('name:ps', 1), ('name:pt', 1), ('name:crh', 1), ('advertising', 1), ('fuel:e10', 1), ('name:frp', 1), ('name:kbd', 1), ('microbrewery', 1), ('name:frr', 1), ('name:ba', 1), ('name:bi', 1), ('baseball', 1), ('name:bo', 1), ('name:bs', 1), ('name:br', 1), ('name:sc', 1), ('name:nrm', 1), ('name:sg', 1), ('Hardware Store', 1), ('wikipedia:en', 1), ('name:lbe', 1), ('name:si', 1), ('name:it', 1), ('name:is', 1), ('name:ik', 1), ('name:ig', 1), ('name:lez', 1), ('name:ia', 1), ('clothes', 1), ('recycling:paper', 1), ('name:ks', 1), ('name:map-bms', 1), ('gnis_state_id', 1), ('cosntruction', 1), ('name:ug', 1), ('recycling:magazines', 1), ('name:zh-yue', 1), ('icao', 1), ('name:als', 1), ('name:kk', 1), ('name:uz', 1), ('name:kl', 1), ('name:kn', 1), ('fenced', 1), ('name:ast', 1), ('name:kv', 1), ('name:bat-smg', 1), ('name:gag', 1), ('tiger:Name', 1), ('health_facility:type', 1)]

def examine_tags(osmfile, tag_range, item_limit):
    assert len(tag_range) == 2
    # use pre-loaded tag_keys list of tuples, if exists
    if TAG_KEYS:
        tag_keys = TAG_KEYS
    # else call mapparser count_tags method to pull sorted list of top tags
    else:
        _, tag_keys = count_tags(osmfile)
    # list comprehension for producing a list of tag_keys in string format
    tag_keys = [tag_key[0] for tag_key in tag_keys][tag_range[0]:tag_range[1]]
    print "Examining tag keys: {}".format(tag_keys)

    # open osm file
    osm_file = open(osmfile, "r")

    # initialize data with default set data structure
    data = defaultdict(set)

    # iterate through elements
    for _, elem in ET.iterparse(osm_file, events=("start",)):
        # check if the element is a node or way
        if elem.tag == "node" or elem.tag == "way":
            # iterate through children matching `tag`
            for tag in elem.iter("tag"):
                # skip if does not contain key-value pair
                if 'k' not in tag.attrib or 'v' not in tag.attrib:
                    continue
                key = tag.get('k')
                val = tag.get('v')
                # add to set if in tag keys of interest and is below the item limit
                if key in tag_keys and len(data[key]) < item_limit:
                    data[key].add(val)
    return data

def main(tag_range=(0, 10), item_limit=10):
    # call examine_tags fucntion
    tag_data = dict(examine_tags(OSMFILE, tag_range, item_limit))

    # convert sets to JSON-read/writeable format (list)
    for key in tag_data:
        tag_data[key] = list(tag_data[key])

    # write to file
    json.dump(tag_data, open(OSMFILE + '-tag-data.json', 'w'))

    # pretty print
    pprint(tag_data)

    # return data
    return tag_data

if __name__ == '__main__':
    main(tag_range=(0, -1), item_limit=20)
